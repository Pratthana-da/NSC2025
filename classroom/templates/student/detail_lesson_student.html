{% extends 'student/base_student.html' %}
{% load static %}
{% block title %}Lesson Detail{% endblock %}

{% block content %}
<div class="max-w-5xl mx-auto px-4 py-10 space-y-10">

    <!-- Lesson Header -->
    <h1 class="text-2xl font-bold text-gray-800">{{ storybook.title }}</h1>
    <p class="text-gray-500 text-sm">By {{ storybook.user.get_full_name|default:storybook.user.email }}</p>

    <!-- Flipbook Frame -->
    <div class="relative bg-black rounded-[20px] w-full h-[600px] overflow-hidden shadow-lg">
        <!-- Scene Pages -->
        <div class="absolute inset-4 bg-white rounded-[16px] grid grid-cols-2 overflow-hidden">
            {% for scene in scenes|slice:":2" %}
            <div class="relative flex items-end justify-center p-4 border-r border-gray-300">
                {% if scene.image_url %}
                <img src="{{ scene.image_url }}" alt="Scene Image" class="absolute inset-0 w-full h-full object-cover">
                {% endif %}
                <div class="relative z-10 flex flex-col items-center space-y-2">
                    <p class="bg-gray-600 text-white text-sm px-4 py-2 rounded-md max-w-[90%] text-center shadow-lg">
                        {{ scene.text }}
                    </p>
                    {% if scene.audio_url %}
                    <audio controls src="{{ scene.audio_url }}" class="w-full max-w-xs"></audio>
                    {% endif %}
                </div>
            </div>
            {% endfor %}
        </div>

        <!-- ‚úÖ ‡∏õ‡∏∏‡πà‡∏° Prev / Next ‡∏ï‡∏¥‡∏î‡∏Ç‡∏≠‡∏ö‡∏ã‡πâ‡∏≤‡∏¢-‡∏Ç‡∏ß‡∏≤ ‡∏Å‡∏•‡∏≤‡∏á‡πÅ‡∏ô‡∏ß‡∏ï‡∏±‡πâ‡∏á -->
        <button id="prev-btn"
            class="absolute top-1/2 left-0 -translate-y-1/2 px-3 py-2 bg-white text-gray-700 rounded-r-lg shadow hover:bg-gray-200 transition z-30">
            ‚¨Ö
        </button>
        <button id="next-btn"
            class="absolute top-1/2 right-0 -translate-y-1/2 px-3 py-2 bg-white text-gray-700 rounded-l-lg shadow hover:bg-gray-200 transition z-30">
            ‚û°
        </button>
    </div>

    <!-- Player Control + Progress -->
    <div class="flex items-center justify-between mt-4 gap-4">
        <!-- Play/Pause -->
        <button id="player-toggle"
            class="flex items-center justify-center w-10 h-10 rounded-full bg-white shadow hover:bg-gray-100 transition">
            <svg id="icon-play" xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 text-gray-800" viewBox="0 0 24 24"
                fill="currentColor">
                <path d="M8 5v14l11-7z" />
            </svg>
            <svg id="icon-pause" xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 text-gray-800 hidden"
                viewBox="0 0 24 24" fill="currentColor">
                <path d="M6 4h4v16H6zM14 4h4v16h-4z" />
            </svg>
        </button>

        <!-- Progress Bar -->
        <div class="flex-1 mx-4">
            <div class="w-full bg-gray-200 h-2 rounded-full overflow-hidden">
                <div id="total-progress-bar" class="bg-indigo-500 h-2 w-0 transition-all duration-200 ease-linear">
                </div>
            </div>
        </div>

        <!-- Time & Mute -->
        <div class="flex items-center gap-3">
            <span id="global-time-display" class="block text-right text-sm text-gray-700 mt-1">00:00 / 00:00</span>
            <button id="mute-btn"
                class="flex items-center justify-center w-9 h-9 rounded-full bg-white shadow hover:bg-gray-100 transition">
                <svg id="icon-sound-on" xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 text-gray-800"
                    viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M11 5L6 9H2v6h4l5 4V5z" />
                    <path stroke-linecap="round" stroke-linejoin="round"
                        d="M15.54 8.46a5 5 0 010 7.07M19.07 4.93a9 9 0 010 12.73" />
                </svg>
                <svg id="icon-sound-off" xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 text-gray-800 hidden"
                    viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M9 5l7 14M15 5l-7 14" />
                </svg>
            </button>
        </div>
    </div>



    <!-- ‚úÖ ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ + ‡πÅ‡∏ä‡∏£‡πå/‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÇ‡∏õ‡∏£‡∏î -->
    <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4 mt-8">

        <!-- üë§ ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ -->
        <!-- ‡πÉ‡∏ä‡πâ storybook.user ‡πÅ‡∏ó‡∏ô request.user -->
        <div class="flex items-center space-x-3">
            <img src="{% if storybook.user.profile_picture %}{{ storybook.user.profile_picture.url }}{% else %}{% static 'images/default_avatar.png' %}{% endif %}"
                class="w-10 h-10 rounded-full object-cover" alt="avatar">
            <div>
                <p class="font-semibold text-sm text-gray-800">{{ storybook.user.get_full_name }}</p>
                <p class="text-xs text-gray-500">‡∏Ñ‡∏£‡∏π‡∏ú‡∏π‡πâ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ö‡∏ó‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</p>
            </div>
        </div>




        <!-- üì§ ‡πÅ‡∏ä‡∏£‡πå + ‚≠ê ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÇ‡∏õ‡∏£‡∏î + ... -->
        <div class="flex items-center gap-3">

            <!-- ‡∏õ‡∏∏‡πà‡∏° ‡πÅ‡∏ä‡∏£‡πå -->
            <button id="share-btn" data-url="{{ request.build_absolute_uri }}"
                class="flex items-center px-4 py-2 rounded-xl bg-white border shadow-sm text-gray-700 text-sm hover:bg-gray-100 transition">
                <i class="fa-solid fa-share-nodes mr-2"></i> ‡πÅ‡∏ä‡∏£‡πå‡∏ö‡∏ó‡πÄ‡∏£‡∏µ‡∏¢‡∏ô
            </button>


            <!-- ‡∏õ‡∏∏‡πà‡∏° ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÇ‡∏õ‡∏£‡∏î -->
            <button
                class="flex items-center px-4 py-2 rounded-xl bg-white border shadow-sm text-gray-700 text-sm hover:bg-gray-100 transition">
                <i class="fa-solid fa-bookmark mr-2"></i> ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÇ‡∏õ‡∏£‡∏î
            </button>

            <!-- ‡∏õ‡∏∏‡πà‡∏° ... ‡πÄ‡∏°‡∏ô‡∏π -->
            <div class="relative">
                <button id="menu-toggle-btn"
                    class="w-9 h-9 flex items-center justify-center rounded-full border bg-white hover:bg-gray-100 text-gray-700 shadow transition">
                    <i class="fa-solid fa-ellipsis"></i>
                </button>

                <!-- ‡πÄ‡∏°‡∏ô‡∏π Dropdown -->
                <div id="menu-dropdown"
                    class="absolute right-0 mt-2 w-40 bg-white rounded-lg shadow-lg py-2 hidden z-50">
                    <a id="export-pdf-btn" href="{% url 'lesson_detail_for_pdf' storybook.id %}"
                        class="flex items-center px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">
                        <i class="fa-solid fa-download mr-2"></i> ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î PDF
                    </a>
                    <button id="open-report-modal"
                        class="flex items-center px-4 py-2 text-sm text-red-600 hover:bg-red-50 w-full">
                        <i class="fa-solid fa-flag mr-2"></i> ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤
                    </button>
                    <!-- Modal -->
                    <div id="report-modal"
                        class="fixed inset-0 bg-black/40 z-50 flex items-center justify-center hidden">
                        <div class="bg-white w-full max-w-md rounded-xl shadow-lg p-6 relative">
                            <button id="close-report-modal"
                                class="absolute top-3 right-3 text-gray-500 hover:text-red-500">‚úï</button>

                            <!-- Step 1 -->
                            <div id="step1">
                                <h2 class="text-lg font-bold mb-2">‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô</h2>
                                <p class="text-sm text-gray-600 mb-4">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏á‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î</p>
                                <ul class="space-y-2">
                                    <li><label><input type="radio" name="reason" value="‡πÑ‡∏°‡πà‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏™‡∏°">
                                            ‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡πÑ‡∏°‡πà‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏™‡∏°</label></li>
                                    <li><label><input type="radio" name="reason" value="‡πÑ‡∏°‡πà‡∏û‡∏≠‡πÉ‡∏à">
                                            ‡πÑ‡∏°‡πà‡∏û‡∏≠‡πÉ‡∏à‡∏ï‡πà‡∏≠‡∏†‡∏≤‡∏û‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤</label></li>
                                    <li><label><input type="radio" name="reason" value="‡∏≠‡∏∑‡πà‡∏ô‡πÜ"> ‡∏≠‡∏∑‡πà‡∏ô ‡πÜ</label></li>
                                </ul>
                                <button id="next-to-step2"
                                    class="mt-6 w-full bg-gray-800 text-white py-2 rounded-lg">‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡πà‡∏≠</button>
                            </div>

                            <!-- Step 2 -->
                            <div id="step2" class="hidden">
                                <button id="back-to-step1" class="text-sm text-blue-600 mb-2">‚Üê ‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö</button>
                                <p class="text-gray-700 text-sm mb-3">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏° (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)</p>
                                <textarea id="detail-text" rows="4" class="w-full border rounded-lg p-2 text-sm"
                                    placeholder="‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î..."></textarea>
                                <button id="submit-report"
                                    class="mt-4 w-full bg-gray-800 text-white py-2 rounded-lg">‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô</button>
                            </div>

                            <!-- Step 3 -->
                            <div id="step3" class="hidden text-center">
                                <p class="text-green-600 font-semibold text-lg mb-2">‚úî ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</p>
                                <p class="text-gray-600 text-sm">‡∏£‡∏∞‡∏ö‡∏ö‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        </div>
        <!-- PDF Loading Overlay -->
        <div id="pdf-loading-overlay" style="
            display: none;
            position: fixed; top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 9999;
        ">
            <div style="
            position: absolute; top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            text-align: center; color: #fff;
            ">
                <i class="fa fa-spinner fa-spin fa-3x"></i>
                <p style="margin-top: .5em; font-size: 1.1em;">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á PDF‚Ä¶</p>
            </div>
        </div>


    </div>

    <!-- ‚úÖ ‡∏õ‡∏∏‡πà‡∏° ‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö + ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î ‡∏≠‡∏¢‡∏π‡πà‡∏Å‡∏•‡∏≤‡∏á‡∏à‡∏≠ -->
    <div class="flex flex-col sm:flex-row items-center justify-center gap-4 mt-6 text-center">
        <a href="{% url 'take_post_test' storybook.id %}">
            <button id="quiz-btn" type="button"
                class="px-6 py-3 rounded-xl bg-gray-800 text-white text-sm hover:bg-gray-700 transition w-full sm:w-auto">
                ‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö
            </button>
        </a>
        <button id="details-toggle-btn" type="button"
            class="px-6 py-3 rounded-xl bg-gray-800 text-white text-sm hover:bg-gray-700 transition w-full sm:w-auto">
            ‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏ö‡∏ó‡πÄ‡∏£‡∏µ‡∏¢‡∏ô
        </button>

    </div>

    <form id="lesson-details" class="mt-8 hidden">
        <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Lesson Name</label>
            <p class="border border-dashed border-blue-400 rounded-lg px-4 py-3 bg-gray-100">
                {{ storybook.title }}
            </p>
        </div>

        <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Creator</label>
            <p class="border border-dashed border-blue-400 rounded-lg px-4 py-3 bg-gray-100">
                {{ storybook.user.get_full_name|default:storybook.user.email }}
            </p>
        </div>

        <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Description</label>
            <div class="border border-dashed border-blue-400 rounded-lg px-4 py-3 bg-gray-100">
                ‡∏ö‡∏ó‡πÄ‡∏£‡∏µ‡∏¢‡∏ô AI ‡∏ó‡∏µ‡πà‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏à‡∏≤‡∏Å PDF/DOCX
            </div>
        </div>

        <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Additional Content</label>
            <div class="border border-dashed border-blue-400 rounded-lg px-4 py-3 bg-gray-100">
                -
            </div>
        </div>
    </form>




    <!-- ‚úÖ ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î‡πÄ‡∏´‡πá‡∏ô -->
    <div class="mt-10 space-y-6">
        <h2 class="text-lg font-bold text-gray-800">243 ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î‡πÄ‡∏´‡πá‡∏ô</h2>

        <!-- ‚úèÔ∏è ‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏Ñ‡∏≠‡∏°‡πÄ‡∏°‡∏ô‡∏ï‡πå + ‡∏õ‡∏∏‡πà‡∏° + ‡∏î‡∏≤‡∏ß -->
        <div class="flex flex-wrap justify-between items-start gap-4">
            <!-- Input -->
            <div class="flex items-start gap-3 flex-1">
                <textarea
                    class="w-full border rounded-xl px-4 py-3 text-sm focus:ring-2 focus:ring-blue-500 focus:outline-none"
                    placeholder="‡∏™‡πà‡∏á‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î‡πÄ‡∏´‡πá‡∏ô‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà..."></textarea>
                <button
                    class="bg-gray-800 text-white w-10 h-10 rounded-full flex items-center justify-center hover:bg-gray-700 transition">
                    <i class="fa-solid fa-paper-plane"></i>
                </button>
            </div>

            <!-- ‚≠êÔ∏è ‡∏î‡∏≤‡∏ß -->
            <div class="flex items-center space-x-1 text-yellow-400 text-lg mt-2 sm:mt-0">
                <i class="fa-solid fa-star hover:scale-110 transition cursor-pointer"></i>
                <i class="fa-solid fa-star hover:scale-110 transition cursor-pointer"></i>
                <i class="fa-solid fa-star hover:scale-110 transition cursor-pointer"></i>
                <i class="fa-solid fa-star hover:scale-110 transition cursor-pointer"></i>
                <i class="fa-solid fa-star hover:scale-110 transition cursor-pointer"></i>
            </div>
        </div>

        <!-- üí¨ ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î‡πÄ‡∏´‡πá‡∏ô -->
        <div class="space-y-6">
            <!-- ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î‡πÄ‡∏´‡πá‡∏ô 1 -->
            <div class="flex justify-between items-start gap-4 border-b pb-4">
                <div class="flex gap-4">
                    <img src="https://randomuser.me/api/portraits/men/12.jpg"
                        class="w-10 h-10 rounded-full object-cover">
                    <div>
                        <p class="font-semibold text-sm text-gray-800">Michael Roberts <span
                                class="text-gray-400">commented on your post</span></p>
                        <p class="text-sm text-gray-600 mt-1">Never underestimate the power of a story. Even the
                            simplest tale can carry deep morals</p>
                        <p class="text-xs text-gray-400 mt-1">08:56 PM on 31 October, 2024</p>
                    </div>
                </div>
                <button class="text-gray-400 hover:text-gray-600">
                    <i class="fa-solid fa-ellipsis"></i>
                </button>
            </div>

            <!-- ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î‡πÄ‡∏´‡πá‡∏ô 2 -->
            <div class="flex justify-between items-start gap-4 border-b pb-4">
                <div class="flex gap-4">
                    <div
                        class="w-10 h-10 rounded-full bg-gray-300 flex items-center justify-center font-bold text-sm text-white">
                        PM</div>
                    <div>
                        <p class="font-semibold text-sm text-gray-800">New Task Assigned <span
                                class="text-gray-400">commented on your post</span></p>
                        <p class="text-sm text-gray-600 mt-1">Never underestimate the power of a story. Even the
                            simplest tale can carry deep morals</p>
                        <p class="text-xs text-gray-400 mt-1">04:25 PM on 31 October, 2024</p>
                    </div>
                </div>
                <button class="text-gray-400 hover:text-gray-600">
                    <i class="fa-solid fa-ellipsis"></i>
                </button>
            </div>

            <!-- ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î‡πÄ‡∏´‡πá‡∏ô 3 -->
            <div class="flex justify-between items-start gap-4 border-b pb-4">
                <div class="flex gap-4">
                    <img src="https://randomuser.me/api/portraits/women/65.jpg"
                        class="w-10 h-10 rounded-full object-cover">
                    <div>
                        <p class="font-semibold text-sm text-gray-800">Jessica Liu <span class="text-gray-400">commented
                                on your post</span></p>
                        <p class="text-sm text-gray-600 mt-1">Even a simple story can leave a strong impact on young
                            learners.</p>
                        <p class="text-xs text-gray-400 mt-1">08:49 PM on 30 October, 2024</p>
                    </div>
                </div>
                <button class="text-gray-400 hover:text-gray-600">
                    <i class="fa-solid fa-ellipsis"></i>
                </button>
            </div>

            <!-- ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î‡πÄ‡∏´‡πá‡∏ô 4 -->
            <div class="flex justify-between items-start gap-4 border-b pb-4">
                <div class="flex gap-4">
                    <img src="https://randomuser.me/api/portraits/men/11.jpg"
                        class="w-10 h-10 rounded-full object-cover">
                    <div>
                        <p class="font-semibold text-sm text-gray-800">Michael Roberts <span
                                class="text-gray-400">commented on your post</span></p>
                        <p class="text-sm text-gray-600 mt-1">Simple but powerful content. Great job!</p>
                        <p class="text-xs text-gray-400 mt-1">08:56 PM on 31 October, 2024</p>
                    </div>
                </div>
                <button class="text-gray-400 hover:text-gray-600">
                    <i class="fa-solid fa-ellipsis"></i>
                </button>
            </div>

            <!-- ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î‡πÄ‡∏´‡πá‡∏ô 5 -->
            <div class="flex justify-between items-start gap-4 border-b pb-4">
                <div class="flex gap-4">
                    <div
                        class="w-10 h-10 rounded-full bg-gray-400 flex items-center justify-center font-bold text-sm text-white">
                        HR</div>
                    <div>
                        <p class="font-semibold text-sm text-gray-800">Reminder <span class="text-gray-400">commented on
                                your post</span></p>
                        <p class="text-sm text-gray-600 mt-1">Learning with stories makes abstract concepts easier to
                            grasp.</p>
                        <p class="text-xs text-gray-400 mt-1">10:30 AM on 30 October, 2024</p>
                    </div>
                </div>
                <button class="text-gray-400 hover:text-gray-600">
                    <i class="fa-solid fa-ellipsis"></i>
                </button>
            </div>
        </div>
    </div>

</div>







<!-- JS -->
<script>
    document.getElementById('share-btn').addEventListener('click', async () => {
        const btn = document.getElementById('share-btn');
        const url = btn.dataset.url;

        // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö Web Share API (‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠/‡∏ö‡∏≤‡∏á desktop)
        if (navigator.share) {
            try {
                await navigator.share({
                    title: document.title,
                    text: '‡πÄ‡∏ä‡∏¥‡∏ç‡∏î‡∏π‡∏ö‡∏ó‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ô‡∏µ‡πâ‡∏Ñ‡∏£‡∏±‡∏ö',
                    url: url
                });
            } catch (err) {
                console.error('Share failed:', err);
            }
        } else {
            // fallback: ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏•‡∏á clipboard
            try {
                await navigator.clipboard.writeText(url);
                // ‡πÅ‡∏™‡∏î‡∏á‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏™‡∏±‡πâ‡∏ô‡πÜ
                const original = btn.innerHTML;
                btn.innerHTML = '<i class="fa-solid fa-check mr-2"></i> ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢';
                setTimeout(() => btn.innerHTML = original, 2000);
            } catch (err) {
                alert('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏•‡∏¥‡∏á‡∏Å‡πå‡πÑ‡∏î‡πâ: ' + err);
            }
        }
    });
</script>

<script>
    document.getElementById('export-pdf-btn').addEventListener('click', function () {
        // ‡πÅ‡∏™‡∏î‡∏á overlay ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ‡∏ó‡∏µ‡πà‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏°
        document.getElementById('pdf-loading-overlay').style.display = 'block';
        // Browser ‡∏à‡∏∞‡∏™‡∏±‡πà‡∏á navigate ‡πÑ‡∏õ‡∏ó‡∏µ‡πà export_lesson_pdf URL
        // ‡∏≠‡∏¢‡πà‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏Å preventDefault() ‡πÑ‡∏ß‡πâ ‡∏à‡∏∞‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡∏Å‡∏≤‡∏£‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡∏∂‡πâ‡∏ô
    });
</script>

<script>
    // ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏°‡∏ô‡∏π ...
    const menuToggleBtn = document.getElementById('menu-toggle-btn');
    const menuDropdown = document.getElementById('menu-dropdown');

    menuToggleBtn.addEventListener('click', () => {
        menuDropdown.classList.toggle('hidden');
    });

    document.addEventListener('click', (e) => {
        if (!menuToggleBtn.contains(e.target) && !menuDropdown.contains(e.target)) {
            menuDropdown.classList.add('hidden');
        }
    });
</script>

<script>
    // ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏™‡∏î‡∏á/‡∏õ‡∏¥‡∏î ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏ö‡∏ó‡πÄ‡∏£‡∏µ‡∏¢‡∏ô
    const detailsToggleBtn = document.getElementById("details-toggle-btn");
    const lessonDetailBox = document.getElementById("lesson-details");

    detailsToggleBtn.addEventListener("click", () => {
        const isHidden = lessonDetailBox.classList.contains("hidden");
        lessonDetailBox.classList.toggle("hidden");

        // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏∏‡πà‡∏°
        detailsToggleBtn.innerText = isHidden ? "‡∏õ‡∏¥‡∏î‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏ö‡∏ó‡πÄ‡∏£‡∏µ‡∏¢‡∏ô" : "‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏ö‡∏ó‡πÄ‡∏£‡∏µ‡∏¢‡∏ô";
    });
</script>


<!-- ‡∏ù‡∏±‡∏á‡∏Ñ‡πà‡∏≤‡∏à‡∏≤‡∏Å Django -->
<div id="storybook-meta" data-storybook-id="{{ storybook.id }}" data-csrf="{{ csrf_token }}"></div>

<script>
    document.addEventListener("DOMContentLoaded", () => {
        // 1) Helpers for formatting & calculating
        const durations = [];      // durations[i] = length of scene i in seconds
        let totalDuration = 0;
        function formatTime(sec) {
            const m = Math.floor(sec / 60);
            const s = String(Math.floor(sec % 60)).padStart(2, '0');
            return `${m}:${s}`;
        }
        function computeTotalDuration() {
            totalDuration = durations.reduce((s, d) => s + (d || 0), 0);
            document.getElementById("global-time-display").textContent =
                `00:00 / ${formatTime(totalDuration)}`;
        }
        function updateGlobalProgress(elapsed) {
            if (!totalDuration) return;
            const pct = Math.min(elapsed / totalDuration * 100, 100);
            document.getElementById("total-progress-bar").style.width = pct + "%";
            document.getElementById("global-time-display").textContent =
                `${formatTime(elapsed)} / ${formatTime(totalDuration)}`;
        }

        // 2) Grab DOM elements
        const meta = document.getElementById("storybook-meta");
        const ws = new WebSocket(`ws://${window.location.host}/ws/storybook/${meta.dataset.storybookId}/`);
        const container = document.querySelector(".grid.grid-cols-2");
        const playBtn = document.getElementById("player-toggle");
        const prevBtn = document.getElementById("prev-btn");
        const nextBtn = document.getElementById("next-btn");
        const muteBtn = document.getElementById("mute-btn");
        const iconPlay = document.getElementById("icon-play");
        const iconPause = document.getElementById("icon-pause");
        const iconOn = document.getElementById("icon-sound-on");
        const iconOff = document.getElementById("icon-sound-off");
        const loading = document.createElement("div");
        loading.id = "loading-message";
        loading.className = "absolute inset-0 flex items-center justify-center text-gray-400 text-sm";
        container.appendChild(loading);

        // 3) State
        let scenesList = [], currentIndex = 0, currentAudioIndex = 0;
        let currentAudios = [], isPlaying = false, isMuted = false;

        function updateLoadingMessage() {
            loading.innerText = `‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏â‡∏≤‡∏Å‡∏ó‡∏µ‡πà ${scenesList.length + 1}‚Ä¶`;
        }

        function toggleIcons() {
            iconPlay.classList.toggle("hidden", isPlaying);
            iconPause.classList.toggle("hidden", !isPlaying);
        }

        // 4) Preload each scene‚Äôs audio OFF-DOM to get its duration
        function preloadDuration(sceneNumber, url) {
            const a = new Audio(url);
            a.preload = "metadata";
            a.addEventListener("loadedmetadata", () => {
                durations[sceneNumber - 1] = a.duration;
                computeTotalDuration();
            }, { once: true });
        }

        // 5) Render 2 pages + their <audio> tags in DOM
        function renderScenePair(left, right) {
            currentAudioIndex = 0;
            container.innerHTML = "";
            [left, right].forEach((scene, idx) => {
                const div = document.createElement("div");
                div.className = "relative flex items-end justify-center p-4 border-r border-gray-300";
                if (scene) {
                    const audioTag = scene.audio_url
                        ? `<audio id="scene-audio-${idx}" src="${scene.audio_url}"></audio>`
                        : "";
                    div.innerHTML = `
          ${scene.image_url ? `<img src="${scene.image_url}" class="absolute inset-0 w-full h-full object-cover">` : ``}
          <div class="relative z-10 flex flex-col items-center space-y-2">
            <p class="bg-gray-600 text-white text-sm px-4 py-2 rounded max-w-[90%] text-center shadow">
              ${scene.text || ""}
            </p>
            ${audioTag}
          </div>`;
                } else {
                    div.innerHTML = `<div class="text-gray-400 italic">Empty Page</div>`;
                }
                container.appendChild(div);
            });

            // delay to ensure <audio> tags are in DOM
            setTimeout(() => {
                applyMute();
                if (isPlaying) {
                    playInOrder(
                        document.getElementById("scene-audio-0"),
                        document.getElementById("scene-audio-1")
                    );
                }
            }, 50);
        }

        function applyMute() {
            document.querySelectorAll("audio").forEach(a => a.muted = isMuted);
        }

        // 6) Play sequentially & update global progress
        async function playInOrder(left, right) {
            currentAudios = [left, right].filter(a => a);
            // bind timeupdate on each
            let offset = durations.slice(0, currentIndex).reduce((s, d) => s + (d || 0), 0);
            currentAudios.forEach((audio, i) => {
                audio.muted = isMuted;
                audio.addEventListener("timeupdate", () => {
                    updateGlobalProgress(offset + audio.currentTime);
                });
            });

            for (let i = currentAudioIndex; i < currentAudios.length; i++) {
                if (!isPlaying) return;
                try {
                    await currentAudios[i].play();
                    await new Promise(res => currentAudios[i].onended = res);
                    offset += currentAudios[i].duration;
                    currentAudioIndex = i + 1;
                } catch { }
            }

            // next pair
            if (isPlaying && currentIndex + 2 < scenesList.length) {
                currentIndex += 2;
                renderScenePair(scenesList[currentIndex], scenesList[currentIndex + 1]);
            }
        }

        // 7) WebSocket: receive each scene, preload its duration, then once you have 2, render pair‚Ä¶
        ws.addEventListener("message", e => {
            const d = JSON.parse(e.data);
            const ns = {
                scene_number: d.scene_number,
                text: d.text,
                image_url: d.image_url,
                audio_url: d.audio_url
            };
            // replace/update
            scenesList = scenesList.filter(s => s.scene_number !== ns.scene_number);
            scenesList.push(ns);
            scenesList.sort((a, b) => a.scene_number - b.scene_number);

            // preload duration
            if (ns.audio_url) preloadDuration(ns.scene_number, ns.audio_url);

            if (scenesList.length >= 2 && loading) {
                loading.remove();
            }
            if (scenesList.length === 2) {
                renderScenePair(scenesList[0], scenesList[1]);
            } else {
                updateLoadingMessage();
            }
        });

        // 8) Controls
        playBtn.addEventListener("click", () => {
            isPlaying = !isPlaying;
            toggleIcons();
            if (isPlaying) {
                playInOrder(
                    document.getElementById("scene-audio-0"),
                    document.getElementById("scene-audio-1")
                );
            } else {
                currentAudios.forEach(a => a.pause());
            }
        });

        muteBtn.addEventListener("click", () => {
            isMuted = !isMuted;
            iconOn.classList.toggle("hidden", isMuted);
            iconOff.classList.toggle("hidden", !isMuted);
            applyMute();
        });

        prevBtn.addEventListener("click", () => {
            if (currentIndex >= 2) {
                currentIndex -= 2;
                currentAudioIndex = 0;
                renderScenePair(scenesList[currentIndex], scenesList[currentIndex + 1]);
            }
        });
        nextBtn.addEventListener("click", () => {
            if (currentIndex + 2 < scenesList.length) {
                currentIndex += 2;
                currentAudioIndex = 0;
                renderScenePair(scenesList[currentIndex], scenesList[currentIndex + 1]);
            }
        });
    });

    // =================== üßæ Modal ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô ====================
    document.getElementById("open-report-modal").onclick = (e) => {
        e.preventDefault();
        document.getElementById("report-modal").classList.remove("hidden");
    };

    document.getElementById("close-report-modal").onclick = () => {
        document.getElementById("report-modal").classList.add("hidden");
    };

    document.getElementById("next-to-step2").onclick = () => {
        const selected = document.querySelector('input[name="reason"]:checked');
        if (!selected) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•");
        document.getElementById("step1").classList.add("hidden");
        document.getElementById("step2").classList.remove("hidden");
    };

    document.getElementById("back-to-step1").onclick = () => {
        document.getElementById("step2").classList.add("hidden");
        document.getElementById("step1").classList.remove("hidden");
    };

    document.getElementById("submit-report").onclick = () => {
        const reason = document.querySelector('input[name="reason"]:checked')?.value;
        const description = document.getElementById("detail-text").value;

        if (!reason) {
            alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•");
            return;
        }

        // ‚úÖ ‡∏î‡∏∂‡∏á‡∏Ñ‡πà‡∏≤ storybookId ‡πÅ‡∏•‡∏∞ csrfToken ‡∏à‡∏≤‡∏Å HTML
        const meta = document.getElementById("storybook-meta");
        const storybookId = meta.dataset.storybookId;
        const csrfToken = meta.dataset.csrf;

        fetch(`/submit-report/${storybookId}/`, {
            method: "POST",
            headers: {
                "Content-Type": "application/x-www-form-urlencoded",
                "X-CSRFToken": csrfToken,
            },
            body: `reason=${encodeURIComponent(reason)}&description=${encodeURIComponent(description)}`
        })
            .then(res => res.json())
            .then(data => {
                if (data.status === "success") {
                    document.getElementById("step2").classList.add("hidden");
                    document.getElementById("step3").classList.remove("hidden");
                } else {
                    alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô");
                    console.log("Form error:", data.errors || data);
                }
            })
            .catch(err => {
                console.error("Report Error:", err);
                alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠");
            });
    };

</script>

{% endblock %}