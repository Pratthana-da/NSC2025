{% extends 'admin/base_admin.html' %}
{% load static %}
{% block title %}Lesson Detail{% endblock %}

{% block content %}
<div class="max-w-5xl mx-auto px-4 py-10 space-y-10">

    <!-- Lesson Header -->
    <h1 class="text-2xl font-bold text-gray-800">{{ storybook.title }}</h1>
    <p class="text-gray-500 text-sm">By {{ storybook.user.get_full_name|default:storybook.user.email }}</p>

    <!-- Flipbook Frame -->
    <div class="relative bg-black rounded-[20px] w-full h-[600px] overflow-hidden shadow-lg">
        <!-- Scene Pages -->
        <div class="absolute inset-4 bg-white rounded-[16px] grid grid-cols-2 overflow-hidden">
            {% for scene in scenes|slice:":2" %}
            <div class="relative flex items-end justify-center p-4 border-r border-gray-300">
                {% if scene.image_url %}
                <img src="{{ scene.image_url }}" alt="Scene Image" class="absolute inset-0 w-full h-full object-cover">
                {% endif %}
                <div class="relative z-10 flex flex-col items-center space-y-2">
                    <p class="bg-gray-600 text-white text-sm px-4 py-2 rounded-md max-w-[90%] text-center shadow-lg">
                        {{ scene.text }}
                    </p>
                    {% if scene.audio_url %}
                    <audio controls src="{{ scene.audio_url }}" class="w-full max-w-xs"></audio>
                    {% endif %}
                </div>
            </div>
            {% endfor %}
        </div>

        <!-- ‚úÖ ‡∏õ‡∏∏‡πà‡∏° Prev / Next ‡∏ï‡∏¥‡∏î‡∏Ç‡∏≠‡∏ö‡∏ã‡πâ‡∏≤‡∏¢-‡∏Ç‡∏ß‡∏≤ ‡∏Å‡∏•‡∏≤‡∏á‡πÅ‡∏ô‡∏ß‡∏ï‡∏±‡πâ‡∏á -->
        <button id="prev-btn"
            class="absolute top-1/2 left-0 -translate-y-1/2 px-3 py-2 bg-white text-gray-700 rounded-r-lg shadow hover:bg-gray-200 transition z-30">
            ‚¨Ö
        </button>
        <button id="next-btn"
            class="absolute top-1/2 right-0 -translate-y-1/2 px-3 py-2 bg-white text-gray-700 rounded-l-lg shadow hover:bg-gray-200 transition z-30">
            ‚û°
        </button>
    </div>

    <!-- Player Control -->
    <div class="flex items-center justify-between text-gray-600 text-sm mt-4">
        <button id="player-toggle"
            class="flex items-center justify-center w-10 h-10 rounded-full bg-white shadow hover:bg-gray-100 transition">
            <!-- ‚ñ∂Ô∏è Icon: ‡πÄ‡∏•‡πà‡∏ô -->
            <svg id="icon-play" xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 text-gray-800" viewBox="0 0 24 24"
                fill="currentColor">
                <path d="M8 5v14l11-7z" />
            </svg>
            <!-- ‚è∏Ô∏è Icon: ‡∏´‡∏¢‡∏∏‡∏î -->
            <svg id="icon-pause" xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 text-gray-800 hidden"
                viewBox="0 0 24 24" fill="currentColor">
                <path d="M6 4h4v16H6zM14 4h4v16h-4z" />
            </svg>
        </button>

        <div class="flex items-center gap-3">
            <span class="text-gray-700 font-medium">01:00</span>
            <!-- üîà ‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏õ‡∏¥‡∏î/‡∏õ‡∏¥‡∏î‡πÄ‡∏™‡∏µ‡∏¢‡∏á -->
            <button id="mute-btn"
                class="flex items-center justify-center w-9 h-9 rounded-full bg-white shadow hover:bg-gray-100 transition">
                <!-- ‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô‡πÄ‡∏õ‡∏¥‡∏î‡πÄ‡∏™‡∏µ‡∏¢‡∏á -->
                <svg id="icon-sound-on" xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 text-gray-800"
                    viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M11 5L6 9H2v6h4l5 4V5z" />
                    <path stroke-linecap="round" stroke-linejoin="round"
                        d="M15.54 8.46a5 5 0 010 7.07M19.07 4.93a9 9 0 010 12.73" />
                </svg>

                <!-- ‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô‡∏õ‡∏¥‡∏î‡πÄ‡∏™‡∏µ‡∏¢‡∏á -->
                <svg id="icon-sound-off" xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 text-gray-800 hidden"
                    viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M9 5l7 14M15 5l-7 14" />
                </svg>
            </button>

        </div>
    </div>

    <!-- ‚úÖ ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ + ‡πÅ‡∏ä‡∏£‡πå/‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÇ‡∏õ‡∏£‡∏î -->
    <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4 mt-8">

        <!-- üë§ ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ -->
        <div class="flex items-center space-x-3">
            <img src="{% static 'images/default_avatar.png' %}" class="w-10 h-10 rounded-full object-cover"
                alt="avatar">
            <div>
                <p class="font-semibold text-sm text-gray-800">{{ request.user.get_full_name }}</p>
                <p class="text-xs text-gray-500">‡∏≠‡∏¢‡πà‡∏≤‡∏•‡∏∑‡∏°‡∏î‡∏π‡∏†‡∏≤‡∏û‡∏ô‡∏¥‡πà‡∏á‡∏î‡πâ‡∏ß‡∏¢‡∏ô‡∏∞‡∏Ñ‡∏£‡∏±‡∏ö</p>
            </div>
        </div>

        <!-- üì§ ‡πÅ‡∏ä‡∏£‡πå + ‚≠ê ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÇ‡∏õ‡∏£‡∏î + ... -->
        <div class="flex items-center gap-3">

            <!-- ‡∏õ‡∏∏‡πà‡∏° ‡πÅ‡∏ä‡∏£‡πå -->
            <button
                class="flex items-center px-4 py-2 rounded-xl bg-white border shadow-sm text-gray-700 text-sm hover:bg-gray-100 transition">
                <i class="fa-solid fa-share-nodes mr-2"></i> ‡πÅ‡∏ä‡∏£‡πå‡πÄ‡∏õ‡πá‡∏ô
            </button>

            <!-- ‡∏õ‡∏∏‡πà‡∏° ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÇ‡∏õ‡∏£‡∏î -->
            <button
                class="flex items-center px-4 py-2 rounded-xl bg-white border shadow-sm text-gray-700 text-sm hover:bg-gray-100 transition">
                <i class="fa-solid fa-bookmark mr-2"></i> ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÇ‡∏õ‡∏£‡∏î
            </button>

            <!-- ‡∏õ‡∏∏‡πà‡∏° ... ‡πÄ‡∏°‡∏ô‡∏π -->
            <div class="relative">
                <button id="menu-toggle-btn"
                    class="w-9 h-9 flex items-center justify-center rounded-full border bg-white hover:bg-gray-100 text-gray-700 shadow transition">
                    <i class="fa-solid fa-ellipsis"></i>
                </button>

                <!-- ‡πÄ‡∏°‡∏ô‡∏π Dropdown -->
                <div id="menu-dropdown"
                    class="absolute right-0 mt-2 w-40 bg-white rounded-lg shadow-lg py-2 hidden z-50">
                    <a href="#" class="flex items-center px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">
                        <i class="fa-solid fa-download mr-2"></i> ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î
                    </a>
                    <!-- ‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏õ‡∏¥‡∏î‡πÄ‡∏°‡∏ô‡∏π -->
                    <a href="#" id="open-report-modal"
                        class="flex items-center px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">
                        <i class="fa-solid fa-flag mr-2"></i> ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô
                    </a>

                    <!-- ‚úÖ Modal -->
                    <div id="report-modal"
                        class="fixed inset-0 bg-black/40 z-50 flex items-center justify-center hidden">
                        <div class="bg-white w-full max-w-md rounded-xl shadow-lg p-6 relative">
                            <button id="close-report-modal"
                                class="absolute top-3 right-3 text-gray-500 hover:text-red-500">‚úï</button>

                            <!-- Step 1 -->
                            <div id="step1">
                                <h2 class="text-lg font-bold mb-2">‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô</h2>
                                <p class="text-sm text-gray-600 mb-4">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏á‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î</p>
                                <ul class="space-y-2">
                                    <li><label><input type="radio" name="reason" value="‡πÑ‡∏°‡πà‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏™‡∏°">
                                            ‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡πÑ‡∏°‡πà‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏™‡∏°</label></li>
                                    <li><label><input type="radio" name="reason" value="‡πÑ‡∏°‡πà‡∏û‡∏≠‡πÉ‡∏à">
                                            ‡πÑ‡∏°‡πà‡∏û‡∏≠‡πÉ‡∏à‡∏ï‡πà‡∏≠‡∏†‡∏≤‡∏û‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤</label></li>
                                    <li><label><input type="radio" name="reason" value="‡∏≠‡∏∑‡πà‡∏ô‡πÜ"> ‡∏≠‡∏∑‡πà‡∏ô ‡πÜ</label></li>
                                </ul>
                                <button id="next-to-step2"
                                    class="mt-6 w-full bg-gray-800 text-white py-2 rounded-lg">‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡πà‡∏≠</button>
                            </div>

                            <!-- Step 2 -->
                            <div id="step2" class="hidden">
                                <button id="back-to-step1" class="text-sm text-blue-600 mb-2">‚Üê ‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö</button>
                                <p class="text-gray-700 text-sm mb-3">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏° (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)</p>
                                <textarea id="detail-text" rows="4" class="w-full border rounded-lg p-2 text-sm"
                                    placeholder="‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î..."></textarea>
                                <button id="submit-report"
                                    class="mt-4 w-full bg-gray-800 text-white py-2 rounded-lg">‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô</button>
                            </div>

                            <!-- Step 3 -->
                            <div id="step3" class="hidden text-center">
                                <p class="text-green-600 font-semibold text-lg mb-2">‚úî ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</p>
                                <p class="text-gray-600 text-sm">‡∏£‡∏∞‡∏ö‡∏ö‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢</p>
                            </div>
                        </div>
                    </div>

                </div>
            </div>

        </div>

    </div>

    <!-- ‚úÖ ‡∏õ‡∏∏‡πà‡∏° ‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö + ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î ‡∏≠‡∏¢‡∏π‡πà‡∏Å‡∏•‡∏≤‡∏á‡∏à‡∏≠ -->
    <div class="flex flex-col sm:flex-row items-center justify-center gap-4 mt-6 text-center">
        <a href="{% url 'take_post_test' storybook.id %}">
            <button id="quiz-btn" type="button"
                class="px-6 py-3 rounded-xl bg-gray-800 text-white text-sm hover:bg-gray-700 transition w-full sm:w-auto">
                ‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö
            </button>
        </a>
        <button id="details-toggle-btn" type="button"
            class="px-6 py-3 rounded-xl bg-gray-800 text-white text-sm hover:bg-gray-700 transition w-full sm:w-auto">
            ‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏ö‡∏ó‡πÄ‡∏£‡∏µ‡∏¢‡∏ô
        </button>

    </div>

    <form id="lesson-details" class="mt-8 hidden">
        <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Lesson Name</label>
            <p class="border border-dashed border-blue-400 rounded-lg px-4 py-3 bg-gray-100">
                {{ storybook.title }}
            </p>
        </div>

        <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Creator</label>
            <p class="border border-dashed border-blue-400 rounded-lg px-4 py-3 bg-gray-100">
                {{ storybook.user.get_full_name|default:storybook.user.email }}
            </p>
        </div>

        <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Description</label>
            <div class="border border-dashed border-blue-400 rounded-lg px-4 py-3 bg-gray-100">
                ‡∏ö‡∏ó‡πÄ‡∏£‡∏µ‡∏¢‡∏ô AI ‡∏ó‡∏µ‡πà‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏à‡∏≤‡∏Å PDF/DOCX
            </div>
        </div>

        <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Additional Content</label>
            <div class="border border-dashed border-blue-400 rounded-lg px-4 py-3 bg-gray-100">
                -
            </div>
        </div>
    </form>




    <!-- ‚úÖ ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î‡πÄ‡∏´‡πá‡∏ô -->
    <div class="mt-10 space-y-6">
        <h2 class="text-lg font-bold text-gray-800">243 ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î‡πÄ‡∏´‡πá‡∏ô</h2>

        <!-- ‚úèÔ∏è ‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏Ñ‡∏≠‡∏°‡πÄ‡∏°‡∏ô‡∏ï‡πå + ‡∏õ‡∏∏‡πà‡∏° + ‡∏î‡∏≤‡∏ß -->
        <div class="flex flex-wrap justify-between items-start gap-4">
            <!-- Input -->
            <div class="flex items-start gap-3 flex-1">
                <textarea
                    class="w-full border rounded-xl px-4 py-3 text-sm focus:ring-2 focus:ring-blue-500 focus:outline-none"
                    placeholder="‡∏™‡πà‡∏á‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î‡πÄ‡∏´‡πá‡∏ô‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà..."></textarea>
                <button
                    class="bg-gray-800 text-white w-10 h-10 rounded-full flex items-center justify-center hover:bg-gray-700 transition">
                    <i class="fa-solid fa-paper-plane"></i>
                </button>
            </div>

            <!-- ‚≠êÔ∏è ‡∏î‡∏≤‡∏ß -->
            <div class="flex items-center space-x-1 text-yellow-400 text-lg mt-2 sm:mt-0">
                <i class="fa-solid fa-star hover:scale-110 transition cursor-pointer"></i>
                <i class="fa-solid fa-star hover:scale-110 transition cursor-pointer"></i>
                <i class="fa-solid fa-star hover:scale-110 transition cursor-pointer"></i>
                <i class="fa-solid fa-star hover:scale-110 transition cursor-pointer"></i>
                <i class="fa-solid fa-star hover:scale-110 transition cursor-pointer"></i>
            </div>
        </div>

        <!-- üí¨ ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î‡πÄ‡∏´‡πá‡∏ô -->
        <div class="space-y-6">
            <!-- ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î‡πÄ‡∏´‡πá‡∏ô 1 -->
            <div class="flex justify-between items-start gap-4 border-b pb-4">
                <div class="flex gap-4">
                    <img src="https://randomuser.me/api/portraits/men/12.jpg"
                        class="w-10 h-10 rounded-full object-cover">
                    <div>
                        <p class="font-semibold text-sm text-gray-800">Michael Roberts <span
                                class="text-gray-400">commented on your post</span></p>
                        <p class="text-sm text-gray-600 mt-1">Never underestimate the power of a story. Even the
                            simplest tale can carry deep morals</p>
                        <p class="text-xs text-gray-400 mt-1">08:56 PM on 31 October, 2024</p>
                    </div>
                </div>
                <button class="text-gray-400 hover:text-gray-600">
                    <i class="fa-solid fa-ellipsis"></i>
                </button>
            </div>

            <!-- ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î‡πÄ‡∏´‡πá‡∏ô 2 -->
            <div class="flex justify-between items-start gap-4 border-b pb-4">
                <div class="flex gap-4">
                    <div
                        class="w-10 h-10 rounded-full bg-gray-300 flex items-center justify-center font-bold text-sm text-white">
                        PM</div>
                    <div>
                        <p class="font-semibold text-sm text-gray-800">New Task Assigned <span
                                class="text-gray-400">commented on your post</span></p>
                        <p class="text-sm text-gray-600 mt-1">Never underestimate the power of a story. Even the
                            simplest tale can carry deep morals</p>
                        <p class="text-xs text-gray-400 mt-1">04:25 PM on 31 October, 2024</p>
                    </div>
                </div>
                <button class="text-gray-400 hover:text-gray-600">
                    <i class="fa-solid fa-ellipsis"></i>
                </button>
            </div>

            <!-- ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î‡πÄ‡∏´‡πá‡∏ô 3 -->
            <div class="flex justify-between items-start gap-4 border-b pb-4">
                <div class="flex gap-4">
                    <img src="https://randomuser.me/api/portraits/women/65.jpg"
                        class="w-10 h-10 rounded-full object-cover">
                    <div>
                        <p class="font-semibold text-sm text-gray-800">Jessica Liu <span class="text-gray-400">commented
                                on your post</span></p>
                        <p class="text-sm text-gray-600 mt-1">Even a simple story can leave a strong impact on young
                            learners.</p>
                        <p class="text-xs text-gray-400 mt-1">08:49 PM on 30 October, 2024</p>
                    </div>
                </div>
                <button class="text-gray-400 hover:text-gray-600">
                    <i class="fa-solid fa-ellipsis"></i>
                </button>
            </div>

            <!-- ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î‡πÄ‡∏´‡πá‡∏ô 4 -->
            <div class="flex justify-between items-start gap-4 border-b pb-4">
                <div class="flex gap-4">
                    <img src="https://randomuser.me/api/portraits/men/11.jpg"
                        class="w-10 h-10 rounded-full object-cover">
                    <div>
                        <p class="font-semibold text-sm text-gray-800">Michael Roberts <span
                                class="text-gray-400">commented on your post</span></p>
                        <p class="text-sm text-gray-600 mt-1">Simple but powerful content. Great job!</p>
                        <p class="text-xs text-gray-400 mt-1">08:56 PM on 31 October, 2024</p>
                    </div>
                </div>
                <button class="text-gray-400 hover:text-gray-600">
                    <i class="fa-solid fa-ellipsis"></i>
                </button>
            </div>

            <!-- ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î‡πÄ‡∏´‡πá‡∏ô 5 -->
            <div class="flex justify-between items-start gap-4 border-b pb-4">
                <div class="flex gap-4">
                    <div
                        class="w-10 h-10 rounded-full bg-gray-400 flex items-center justify-center font-bold text-sm text-white">
                        HR</div>
                    <div>
                        <p class="font-semibold text-sm text-gray-800">Reminder <span class="text-gray-400">commented on
                                your post</span></p>
                        <p class="text-sm text-gray-600 mt-1">Learning with stories makes abstract concepts easier to
                            grasp.</p>
                        <p class="text-xs text-gray-400 mt-1">10:30 AM on 30 October, 2024</p>
                    </div>
                </div>
                <button class="text-gray-400 hover:text-gray-600">
                    <i class="fa-solid fa-ellipsis"></i>
                </button>
            </div>
        </div>
    </div>

</div>







<!-- JS -->
<script>
    // ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏°‡∏ô‡∏π ...
    const menuToggleBtn = document.getElementById('menu-toggle-btn');
    const menuDropdown = document.getElementById('menu-dropdown');

    menuToggleBtn.addEventListener('click', () => {
        menuDropdown.classList.toggle('hidden');
    });

    document.addEventListener('click', (e) => {
        if (!menuToggleBtn.contains(e.target) && !menuDropdown.contains(e.target)) {
            menuDropdown.classList.add('hidden');
        }
    });
</script>

<script>
    // ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏™‡∏î‡∏á/‡∏õ‡∏¥‡∏î ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏ö‡∏ó‡πÄ‡∏£‡∏µ‡∏¢‡∏ô
    const detailsToggleBtn = document.getElementById("details-toggle-btn");
    const lessonDetailBox = document.getElementById("lesson-details");

    detailsToggleBtn.addEventListener("click", () => {
        const isHidden = lessonDetailBox.classList.contains("hidden");
        lessonDetailBox.classList.toggle("hidden");

        // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏∏‡πà‡∏°
        detailsToggleBtn.innerText = isHidden ? "‡∏õ‡∏¥‡∏î‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏ö‡∏ó‡πÄ‡∏£‡∏µ‡∏¢‡∏ô" : "‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏ö‡∏ó‡πÄ‡∏£‡∏µ‡∏¢‡∏ô";
    });
</script>



<script>
    const scenes = {{ scenes| safe }};
    const container = document.querySelector(".grid.grid-cols-2");
    let currentIndex = 0;

    function renderScenes(index) {
        container.innerHTML = "";
        const left = scenes[index];
        const right = scenes[index + 1];

        [left, right].forEach((scene) => {
            const sceneDiv = document.createElement("div");
            sceneDiv.className = "relative flex items-end justify-center p-4 border-r border-gray-300";

            if (scene) {
                sceneDiv.innerHTML = `
                    ${scene.image_url ? `<img src="${scene.image_url}" alt="Scene" class="absolute inset-0 w-full h-full object-cover">` : ''}
                    <div class="relative z-10 flex flex-col items-center space-y-2">
                        <p class="bg-gray-600 text-white text-sm px-4 py-2 rounded-md max-w-[90%] text-center shadow-lg">
                            ${scene.text || ''}
                        </p>
                        ${scene.audio_url ? `<audio controls src="${scene.audio_url}" class="w-full max-w-xs"></audio>` : ''}
                    </div>
                `;
            } else {
                sceneDiv.innerHTML = `<div class="text-gray-400 text-sm italic">Empty Page</div>`;
            }

            container.appendChild(sceneDiv);
        });
    }

    document.getElementById("next-btn")?.addEventListener("click", () => {
        currentIndex = (currentIndex + 2) % scenes.length;
        renderScenes(currentIndex);
    });

    document.getElementById("prev-btn")?.addEventListener("click", () => {
        currentIndex = (currentIndex - 2 + scenes.length) % scenes.length;
        renderScenes(currentIndex);
    });

    renderScenes(0); // Initial render
</script>

<script>
    const toggleBtn = document.getElementById('menu-toggle');
    const dropdown = document.getElementById('menu-dropdown');

    toggleBtn.addEventListener('click', () => {
        dropdown.classList.toggle('hidden');
    });

    // ‡∏õ‡∏¥‡∏î dropdown ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Ñ‡∏•‡∏¥‡∏Å‡∏Ç‡πâ‡∏≤‡∏á‡∏ô‡∏≠‡∏Å
    document.addEventListener('click', (e) => {
        if (!toggleBtn.contains(e.target) && !dropdown.contains(e.target)) {
            dropdown.classList.add('hidden');
        }
    });
</script>


<script>
    document.querySelectorAll('.fa-star').forEach((star, index, stars) => {
        star.addEventListener('click', () => {
            stars.forEach((s, i) => {
                s.classList.toggle('text-yellow-400', i <= index);
                s.classList.toggle('text-gray-400', i > index);
            });
        });
    });
</script>


<!-- ‚úÖ ‡∏ù‡∏±‡∏á‡∏Ñ‡πà‡∏≤‡∏à‡∏≤‡∏Å Django -->
<div id="storybook-meta"
     data-storybook-id="{{ storybook.id }}"
     data-csrf="{{ csrf_token }}">
</div>



<script>
    // ‚úÖ ‡∏î‡∏∂‡∏á‡∏Ñ‡πà‡∏≤‡∏à‡∏≤‡∏Å HTML ‡∏ó‡∏µ‡πà‡∏ù‡∏±‡∏á‡πÑ‡∏ß‡πâ
    const meta = document.getElementById("storybook-meta");
    const storybookId = meta.dataset.storybookId;
    const csrfToken = meta.dataset.csrf;

    const ws = new WebSocket(`ws://${window.location.host}/ws/storybook/${storybookId}/`);

    let scenesList = [];
    let currentIndex = 0;
    let currentAudioIndex = 0;
    let currentAudios = [];
    let isPlaying = false;
    let isMuted = false;

    const container = document.querySelector(".grid.grid-cols-2");
    const playerBtn = document.getElementById("player-toggle");
    const iconPlay = document.getElementById("icon-play");
    const iconPause = document.getElementById("icon-pause");

    const muteBtn = document.getElementById('mute-btn');
    const iconSoundOn = document.getElementById('icon-sound-on');
    const iconSoundOff = document.getElementById('icon-sound-off');

    const loadingDiv = document.createElement("div");
    loadingDiv.className = "absolute inset-0 flex items-center justify-center text-gray-400 text-sm";
    loadingDiv.id = "loading-message";
    container.appendChild(loadingDiv);

    function updateLoadingMessage() {
        const expectedScene = scenesList.length + 1;
        loadingDiv.innerText = `‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏â‡∏≤‡∏Å‡∏ó‡∏µ‡πà ${expectedScene}...`;
    }

    function togglePlayerIcon() {
        iconPlay.classList.toggle("hidden", isPlaying);
        iconPause.classList.toggle("hidden", !isPlaying);
    }

    function applyMuteToCurrentAudios() {
        document.querySelectorAll('audio').forEach(audio => {
            audio.muted = isMuted;
        });
    }

    muteBtn?.addEventListener('click', () => {
        isMuted = !isMuted;
        iconSoundOn.classList.toggle('hidden', isMuted);
        iconSoundOff.classList.toggle('hidden', !isMuted);
        applyMuteToCurrentAudios();
    });

    async function playInOrder(audioLeft, audioRight) {
        currentAudios = [audioLeft, audioRight].filter(a => a);
        const audioList = currentAudios;
        audioList.forEach(audio => audio.muted = isMuted);

        for (let i = currentAudioIndex; i < audioList.length; i++) {
            if (!isPlaying) return;

            try {
                await audioList[i].play();
                await new Promise(resolve => {
                    audioList[i].onended = () => {
                        currentAudioIndex = i + 1;
                        resolve();
                    };
                });
            } catch (e) {
                console.warn("Failed to play audio", e);
            }
        }

        if (isPlaying && currentIndex + 2 < scenesList.length) {
            currentIndex += 2;
            currentAudioIndex = 0;
            renderScenePair(scenesList[currentIndex], scenesList[currentIndex + 1]);
        }
    }

    function renderScenePair(left, right) {
        currentAudioIndex = 0;
        container.innerHTML = '';
        [left, right].forEach((scene, index) => {
            const sceneDiv = document.createElement("div");
            sceneDiv.className = "relative flex items-end justify-center p-4 border-r border-gray-300";

            if (scene) {
                const audioHtml = scene.audio_url
                    ? `<audio id="scene-audio-${index}" src="${scene.audio_url}" class="w-full max-w-xs"></audio>`
                    : '';

                sceneDiv.innerHTML = `
                    ${scene.image_url ? `<img src="${scene.image_url}" class="absolute inset-0 w-full h-full object-cover">` : ''}
                    <div class="relative z-10 flex flex-col items-center space-y-2">
                        <p class="bg-gray-600 text-white text-sm px-4 py-2 rounded-md max-w-[90%] text-center shadow-lg">
                            ${scene.text || ''}
                        </p>
                        ${audioHtml}
                    </div>
                `;
            } else {
                sceneDiv.innerHTML = `<div class="text-gray-400 text-sm italic">Empty Page</div>`;
            }

            container.appendChild(sceneDiv);
        });

        setTimeout(() => {
            applyMuteToCurrentAudios();
            if (isPlaying) {
                const audioLeft = document.getElementById("scene-audio-0");
                const audioRight = document.getElementById("scene-audio-1");
                playInOrder(audioLeft, audioRight);
            }
        }, 300);
    }

    ws.addEventListener('message', function (event) {
        const data = JSON.parse(event.data);
        const newScene = {
            scene_number: data.scene_number,
            text: data.text,
            image_url: data.image_url,
            audio_url: data.audio_url,
        };

        scenesList = scenesList.filter(scene => scene.scene_number !== newScene.scene_number);
        scenesList.push(newScene);
        scenesList.sort((a, b) => a.scene_number - b.scene_number);

        if (scenesList.length === 2) {
            currentIndex = 0;
            renderScenePair(scenesList[0], scenesList[1]);
        }

        updateLoadingMessage();
    });

    playerBtn?.addEventListener("click", () => {
        isPlaying = !isPlaying;
        togglePlayerIcon();

        if (isPlaying) {
            const audioLeft = document.getElementById("scene-audio-0");
            const audioRight = document.getElementById("scene-audio-1");
            playInOrder(audioLeft, audioRight);
        } else {
            currentAudios.forEach(audio => {
                audio.pause();
            });
        }
    });

    document.getElementById("next-btn")?.addEventListener("click", () => {
        if (currentIndex + 2 < scenesList.length) {
            currentIndex += 2;
            currentAudioIndex = 0;
            renderScenePair(scenesList[currentIndex], scenesList[currentIndex + 1]);
        }
    });

    document.getElementById("prev-btn")?.addEventListener("click", () => {
        if (currentIndex - 2 >= 0) {
            currentIndex -= 2;
            currentAudioIndex = 0;
            renderScenePair(scenesList[currentIndex], scenesList[currentIndex + 1]);
        }
    });

    updateLoadingMessage();

    // =================== üßæ Modal ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô ====================
    document.getElementById("open-report-modal").onclick = (e) => {
        e.preventDefault();
        document.getElementById("report-modal").classList.remove("hidden");
    };

    document.getElementById("close-report-modal").onclick = () => {
        document.getElementById("report-modal").classList.add("hidden");
    };

    document.getElementById("next-to-step2").onclick = () => {
        const selected = document.querySelector('input[name="reason"]:checked');
        if (!selected) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•");
        document.getElementById("step1").classList.add("hidden");
        document.getElementById("step2").classList.remove("hidden");
    };

    document.getElementById("back-to-step1").onclick = () => {
        document.getElementById("step2").classList.add("hidden");
        document.getElementById("step1").classList.remove("hidden");
    };

    document.getElementById("submit-report").onclick = () => {
        const reason = document.querySelector('input[name="reason"]:checked')?.value;
        const detail = document.getElementById("detail-text").value;

        fetch(`/submit-report/${storybookId}/`, {
            method: "POST",
            headers: {
                "Content-Type": "application/x-www-form-urlencoded",
                "X-CSRFToken": csrfToken,
            },
            body: `reason=${encodeURIComponent(reason)}&detail=${encodeURIComponent(detail)}`
        })
        .then(res => res.json())
        .then(data => {
            if (data.status === "success") {
                document.getElementById("step2").classList.add("hidden");
                document.getElementById("step3").classList.remove("hidden");
            } else {
                alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô");
            }
        })
        .catch(err => {
            console.error("Report Error:", err);
            alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠");
        });
    };
</script>




{% endblock %}