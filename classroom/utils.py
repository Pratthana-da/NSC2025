from openai import OpenAI
from io import BytesIO
import PyPDF2
import json
import logging
import re

logger = logging.getLogger(__name__)
logging.basicConfig(level=logging.INFO)

client = OpenAI()

# ========== 1. ‡πÅ‡∏õ‡∏•‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏™‡∏µ‡∏¢‡∏á ==========
def generate_tts_audio(text, voice="nova"):
    response = client.audio.speech.create(
        model="tts-1",
        voice=voice,
        input=text,
    )
    return response.read()  # bytes ‡∏Ç‡∏≠‡∏á‡πÑ‡∏ü‡∏•‡πå mp3


# ========== 2. ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏à‡∏≤‡∏Å PDF ==========
def extract_text_from_pdf(file_obj) -> str:
    text = ""
    reader = PyPDF2.PdfReader(file_obj)
    for page_number, page in enumerate(reader.pages, start=1):
        page_text = page.extract_text() or ""
        logger.info(f"----- Extracted from page {page_number} -----")
        for line in page_text.splitlines():
            logger.info(line[:200])
        text += f"\n--- ‡∏´‡∏ô‡πâ‡∏≤ {page_number} ---\n" + page_text + "\n"
    logger.info("===== Total extracted text length: %d chars =====", len(text))
    return text


# ========== 3. ‡∏™‡∏£‡∏∏‡∏õ‡πÄ‡∏õ‡πá‡∏ô‡∏ô‡∏¥‡∏ó‡∏≤‡∏ô 20 ‡∏â‡∏≤‡∏Å ==========
def summarize_to_scenes(raw_text):
    system_prompt = (
        "‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏∑‡∏≠‡∏ú‡∏π‡πâ‡∏ä‡πà‡∏ß‡∏¢ AI ‡∏ó‡∏µ‡πà‡πÄ‡∏ä‡∏µ‡πà‡∏¢‡∏ß‡∏ä‡∏≤‡∏ç‡∏î‡πâ‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏õ‡∏•‡∏á‡∏ö‡∏ó‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏¢‡∏≤‡∏Å ‡πÜ ‡πÉ‡∏´‡πâ‡∏Å‡∏•‡∏≤‡∏¢‡πÄ‡∏õ‡πá‡∏ô‡∏ô‡∏¥‡∏ó‡∏≤‡∏ô‡∏†‡∏≤‡∏û‡∏ó‡∏µ‡πà‡πÄ‡∏î‡πá‡∏Å‡∏õ‡∏£‡∏∞‡∏ñ‡∏°‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏à‡πÑ‡∏î‡πâ "
        "‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏∑‡∏≠‡∏ä‡πà‡∏ß‡∏¢‡πÉ‡∏´‡πâ‡πÄ‡∏î‡πá‡∏Å‡∏≠‡∏≤‡∏¢‡∏∏ 7‚Äì12 ‡∏õ‡∏µ‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏à‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡∏ó‡∏≤‡∏á‡∏ß‡∏¥‡∏ä‡∏≤‡∏Å‡∏≤‡∏£ ‡πÄ‡∏ä‡πà‡∏ô ‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå ‡∏Ñ‡∏ì‡∏¥‡∏ï‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå ‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢ "
        "‡∏ú‡πà‡∏≤‡∏ô‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÄ‡∏•‡πà‡∏≤‡πÅ‡∏ö‡∏ö‡∏ô‡∏¥‡∏ó‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏ï‡∏±‡∏ß‡∏•‡∏∞‡∏Ñ‡∏£ ‡∏â‡∏≤‡∏Å ‡πÅ‡∏•‡∏∞‡∏†‡∏≤‡∏û‡∏ó‡∏µ‡πà‡∏ô‡πà‡∏≤‡∏™‡∏ô‡πÉ‡∏à "
        "‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡πÅ‡∏õ‡∏•‡∏á‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏£‡∏≤‡∏ß 20 ‡∏â‡∏≤‡∏Å‡∏ï‡πà‡∏≠‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á ‡πÇ‡∏î‡∏¢‡πÉ‡∏ä‡πâ‡∏†‡∏≤‡∏©‡∏≤‡∏á‡πà‡∏≤‡∏¢ ‡∏™‡∏ô‡∏∏‡∏Å ‡πÅ‡∏•‡∏∞‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡πÇ‡∏¢‡∏á‡∏Å‡∏±‡∏ö‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï‡∏à‡∏£‡∏¥‡∏á‡∏Ç‡∏≠‡∏á‡πÄ‡∏î‡πá‡∏Å "
        "‡∏†‡∏≤‡∏û‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö‡∏à‡∏∞‡πÉ‡∏ä‡πâ prompt ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏†‡∏≤‡∏û‡∏à‡∏≤‡∏Å DALL¬∑E ‡πÇ‡∏î‡∏¢‡∏ï‡πâ‡∏≠‡∏á‡∏£‡∏∞‡∏ö‡∏∏‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î ‡∏â‡∏≤‡∏Å, ‡∏ï‡∏±‡∏ß‡∏•‡∏∞‡∏Ñ‡∏£, ‡∏™‡∏µ‡∏™‡∏±‡∏ô, ‡∏≠‡∏≤‡∏£‡∏°‡∏ì‡πå ‡πÅ‡∏•‡∏∞ **‡∏™‡πÑ‡∏ï‡∏•‡πå‡∏ô‡∏¥‡∏ó‡∏≤‡∏ô‡πÅ‡∏ô‡∏ß‡∏Å‡∏≤‡∏£‡πå‡∏ï‡∏π‡∏ô**(cartoon style, storybook illustration) ‡∏ã‡∏∂‡πà‡∏á‡∏ï‡πâ‡∏≠‡∏á‡∏™‡∏∑‡πà‡∏≠‡∏â‡∏≤‡∏Å‡πÅ‡∏•‡∏∞‡∏ï‡∏±‡∏ß‡∏•‡∏∞‡∏Ñ‡∏£‡πÉ‡∏´‡πâ‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô"
    )

    user_prompt = f"""
‡∏ö‡∏ó‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ï‡πâ‡∏ô‡∏â‡∏ö‡∏±‡∏ö:
\"\"\" 
{raw_text}
\"\"\"

‡∏à‡∏∏‡∏î‡∏õ‡∏£‡∏∞‡∏™‡∏á‡∏Ñ‡πå‡∏Ç‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏õ‡∏•‡∏á:
- ‡πÉ‡∏´‡πâ‡πÄ‡∏î‡πá‡∏Å‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏à‡∏ö‡∏ó‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏¢‡∏≤‡∏Å ‡πÜ ‡∏ú‡πà‡∏≤‡∏ô‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏£‡∏≤‡∏ß‡∏ó‡∏µ‡πà‡∏™‡∏ô‡∏∏‡∏Å
- ‡πÉ‡∏ä‡πâ‡∏ï‡∏±‡∏ß‡∏•‡∏∞‡∏Ñ‡∏£/‡∏â‡∏≤‡∏Å‡∏ó‡∏µ‡πà‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡πÇ‡∏¢‡∏á‡∏Å‡∏±‡∏ö‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ß‡∏±‡∏ô
- ‡πÄ‡∏™‡∏£‡∏¥‡∏°‡∏ó‡∏±‡∏Å‡∏©‡∏∞‡∏Å‡∏≤‡∏£‡∏Ñ‡∏¥‡∏î ‡πÄ‡∏ä‡πà‡∏ô ‡∏Å‡∏≤‡∏£‡∏™‡∏±‡∏á‡πÄ‡∏Å‡∏ï ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì ‡∏Ñ‡∏¥‡∏î‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå ‡∏ú‡πà‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡πà‡∏≤‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á
- ‡πÉ‡∏´‡πâ‡πÄ‡∏î‡πá‡∏Å‡∏™‡∏ô‡∏∏‡∏Å‡πÅ‡∏•‡∏∞‡πÑ‡∏°‡πà‡∏Å‡∏•‡∏±‡∏ß‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡∏ó‡∏≤‡∏á‡∏ß‡∏¥‡∏ä‡∏≤‡∏Å‡∏≤‡∏£
- ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô "text" ‡∏Ç‡∏≠‡∏á‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏â‡∏≤‡∏Å‡πÉ‡∏´‡πâ‡∏°‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏≤‡∏ß‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì 1 ‡∏¢‡πà‡∏≠‡∏´‡∏ô‡πâ‡∏≤ (40‚Äì60 ‡∏Ñ‡∏≥) ‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô 2 ‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î ‡πÉ‡∏ä‡πâ‡∏†‡∏≤‡∏©‡∏≤‡∏ó‡∏µ‡πà‡∏Å‡∏£‡∏∞‡∏ä‡∏±‡∏ö ‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏î‡πá‡∏Å‡∏õ‡∏£‡∏∞‡∏ñ‡∏° ‡πÅ‡∏•‡∏∞‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏à‡∏á‡πà‡∏≤‡∏¢ ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡πÇ‡∏¢‡∏á‡∏Å‡∏±‡∏ö‡∏â‡∏≤‡∏Å‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤

‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏™‡∏£‡∏∏‡∏õ‡∏ö‡∏ó‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ô‡∏µ‡πâ‡πÄ‡∏õ‡πá‡∏ô **‡∏ô‡∏¥‡∏ó‡∏≤‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏î‡πá‡∏Å 20 ‡∏â‡∏≤‡∏Å** (scene 1-20) ‡πÇ‡∏î‡∏¢‡∏°‡∏µ‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö JSON ‡∏•‡πâ‡∏ß‡∏ô ‡πÜ ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô
‡∏´‡πâ‡∏≤‡∏°‡∏°‡∏µ‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡∏≠‡∏∑‡πà‡∏ô‡∏ô‡∏≠‡∏Å‡∏à‡∏≤‡∏Å JSON

**‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏â‡∏≤‡∏Å** ‡∏ï‡πâ‡∏≠‡∏á‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö‡∏î‡πâ‡∏ß‡∏¢:
- `"scene"`: ‡πÄ‡∏•‡∏Ç‡∏â‡∏≤‡∏Å ‡πÄ‡∏ä‡πà‡∏ô 1, 2, 3 ...
- `"text"`: ‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡∏ô‡∏¥‡∏ó‡∏≤‡∏ô‡πÉ‡∏ô‡∏â‡∏≤‡∏Å‡∏ô‡∏±‡πâ‡∏ô ‡πÉ‡∏ä‡πâ‡∏†‡∏≤‡∏©‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏à‡∏á‡πà‡∏≤‡∏¢ ‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏Å‡∏±‡∏ö‡πÄ‡∏î‡πá‡∏Å‡∏õ‡∏£‡∏∞‡∏ñ‡∏° ‡πÅ‡∏•‡∏∞‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡∏Ñ‡∏ß‡∏£‡∏ï‡πà‡∏≠‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏≤‡∏Å‡∏â‡∏≤‡∏Å‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤ ‡πÇ‡∏î‡∏¢‡∏°‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏≤‡∏ß‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì 1 ‡∏¢‡πà‡∏≠‡∏´‡∏ô‡πâ‡∏≤ (40‚Äì60 ‡∏Ñ‡∏≥) ‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô 2 ‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏Å‡∏£‡∏∞‡∏ä‡∏±‡∏ö‡πÅ‡∏•‡∏∞‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏™‡∏î‡∏á‡∏ï‡πà‡∏≠‡∏â‡∏≤‡∏Å‡∏†‡∏≤‡∏û‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö
- `"image_prompt"`: prompt ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏†‡∏≤‡∏û‡∏à‡∏≤‡∏Å DALL¬∑E ‡πÇ‡∏î‡∏¢‡∏ï‡πâ‡∏≠‡∏á‡∏£‡∏∞‡∏ö‡∏∏‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î: ‡∏â‡∏≤‡∏Å, ‡∏ï‡∏±‡∏ß‡∏•‡∏∞‡∏Ñ‡∏£, ‡∏™‡∏µ‡∏™‡∏±‡∏ô, ‡∏≠‡∏≤‡∏£‡∏°‡∏ì‡πå ‡πÅ‡∏•‡∏∞ **‡∏™‡πÑ‡∏ï‡∏•‡πå‡∏ô‡∏¥‡∏ó‡∏≤‡∏ô‡πÅ‡∏ô‡∏ß‡∏Å‡∏≤‡∏£‡πå‡∏ï‡∏π‡∏ô**
  (‡πÄ‡∏ä‡πà‡∏ô ‚Äú‡πÄ‡∏î‡πá‡∏Å‡∏ä‡∏≤‡∏¢‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ñ‡∏∑‡∏≠‡∏™‡∏°‡∏∏‡∏î‡∏†‡∏≤‡∏û‡πÉ‡∏ô‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ó‡∏µ‡πà‡∏≠‡∏ö‡∏≠‡∏∏‡πà‡∏ô ‡∏°‡∏µ‡∏Ñ‡∏£‡∏π‡πÉ‡∏à‡∏î‡∏µ‡∏¢‡∏∑‡∏ô‡∏Ç‡πâ‡∏≤‡∏á‡πÜ ‡πÅ‡∏™‡∏á‡πÅ‡∏î‡∏î‡∏™‡πà‡∏≠‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á ‡∏™‡πÑ‡∏ï‡∏•‡πå‡∏Å‡∏≤‡∏£‡πå‡∏ï‡∏π‡∏ô cartoon style, storybook illustration‚Äù)

**‡∏Ñ‡∏≥‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç:
- ‡∏´‡πâ‡∏≤‡∏°‡∏ï‡∏≠‡∏ö JSON ‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå ‡πÄ‡∏ä‡πà‡∏ô ‡∏Ç‡∏≤‡∏î ] ‡∏´‡∏£‡∏∑‡∏≠ " ‡∏´‡∏£‡∏∑‡∏≠ ‡∏õ‡∏¥‡∏î‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö
- ‡∏´‡∏≤‡∏Å‡∏â‡∏≤‡∏Å‡∏™‡∏∏‡∏î‡∏ó‡πâ‡∏≤‡∏¢‡πÑ‡∏°‡πà‡πÅ‡∏ô‡πà‡πÉ‡∏à ‡πÉ‡∏´‡πâ‡πÄ‡∏ß‡πâ‡∏ô‡πÑ‡∏ß‡πâ‡∏´‡∏£‡∏∑‡∏≠‡∏õ‡∏¥‡∏î‡∏î‡πâ‡∏ß‡∏¢ []

‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö JSON:
[
  {{
    "scene": 1,
    "text": "‡∏ô‡πâ‡∏≠‡∏á‡∏°‡∏≤‡∏¢‡∏î‡πå‡πÄ‡∏î‡∏¥‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏õ‡πÉ‡∏ô‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÉ‡∏´‡∏°‡πà ‡∏ó‡∏µ‡πà‡πÄ‡∏ï‡πá‡∏°‡πÑ‡∏õ‡∏î‡πâ‡∏ß‡∏¢‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡∏û‡∏•‡∏±‡∏á‡∏á‡∏≤‡∏ô‡πÅ‡∏™‡∏á‡∏≠‡∏≤‡∏ó‡∏¥‡∏ï‡∏¢‡πå...",
    "image_prompt": "‡πÄ‡∏î‡πá‡∏Å‡∏´‡∏ç‡∏¥‡∏á‡∏ú‡∏°‡∏¢‡∏≤‡∏ß‡πÉ‡∏™‡πà‡∏ä‡∏∏‡∏î‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô ‡∏¢‡∏∑‡∏ô‡πÉ‡∏ô‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏™‡∏ß‡πà‡∏≤‡∏á‡πÑ‡∏™‡∏ß ‡∏°‡∏µ‡πÅ‡∏ú‡∏á‡πÇ‡∏ã‡∏•‡∏≤‡∏£‡πå‡πÄ‡∏ã‡∏•‡∏•‡πå‡∏ö‡∏ô‡∏ú‡∏ô‡∏±‡∏á ‡∏™‡πÑ‡∏ï‡∏•‡πå‡∏Å‡∏≤‡∏£‡πå‡∏ï‡∏π‡∏ô cartoon style, storybook illustration"
  }},
  ...
]
"""

    response = client.chat.completions.create(
        model="gpt-4-1106-preview",
        messages=[
            {"role": "system", "content": system_prompt},
            {"role": "user", "content": user_prompt}
        ],
        temperature=0.7
    )

    result_text = response.choices[0].message.content.strip()

    # ‡∏•‡πâ‡∏≤‡∏á ```json ‡∏´‡∏£‡∏∑‡∏≠ ```
    if result_text.startswith("```json"):
        result_text = result_text[7:]
    elif result_text.startswith("```"):
        result_text = result_text[3:]
    if result_text.endswith("```"):
        result_text = result_text[:-3]

    logger.warning("===== JSON TAIL (last 1000 chars) =====\n%s", result_text)

    try:
        return json.loads(result_text)

    except json.JSONDecodeError as e:
        logger.warning("‚ùå JSONDecodeError: %s", str(e))
        if not result_text.endswith("]"):
            fixed = result_text.rsplit('{', 1)[0].rstrip(', \n') + "\n]"
            try:
                return json.loads(fixed)
            except Exception as e2:
                raise ValueError("‡πÅ‡∏Å‡πâ‡πÅ‡∏•‡πâ‡∏ß‡πÅ‡∏ï‡πà‡∏¢‡∏±‡∏á‡∏û‡∏±‡∏á‡∏≠‡∏¢‡∏π‡πà: " + str(e2))
        else:
            raise ValueError("‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÅ‡∏õ‡∏•‡∏á JSON ‡πÑ‡∏î‡πâ: " + str(e))


# ========== 4. ‡∏Å‡∏£‡∏≠‡∏á‡∏Ñ‡∏≥‡∏ï‡πâ‡∏≠‡∏á‡∏´‡πâ‡∏≤‡∏°‡πÅ‡∏ö‡∏ö‡πÄ‡∏´‡∏°‡∏≤‡∏£‡∏ß‡∏° ==========
def sanitize_prompt(prompt: str) -> str:
    bad_words = [
        # ‡∏Ñ‡∏≥‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡∏£‡πà‡∏≤‡∏á‡∏Å‡∏≤‡∏¢‡πÅ‡∏•‡∏∞‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏∏‡∏ô‡πÅ‡∏£‡∏á
        r"‡∏≠‡∏ß‡∏±‡∏¢‡∏ß‡∏∞", r"‡∏≠‡∏ß‡∏±‡∏¢‡∏ß‡∏∞‡πÄ‡∏û‡∏®", r"‡∏≠‡∏ß‡∏±‡∏¢‡∏ß‡∏∞‡∏†‡∏≤‡∏¢‡πÉ‡∏ô", r"‡∏ô‡∏°", r"‡∏´‡∏ô‡πâ‡∏≤‡∏≠‡∏Å", r"‡πÄ‡∏ï‡πâ‡∏≤‡∏ô‡∏°", r"‡∏™‡∏∞‡πÇ‡∏û‡∏Å",
        r"‡πÄ‡∏•‡∏∑‡∏≠‡∏î", r"‡∏ï‡∏≤‡∏¢", r"‡∏Ü‡πà‡∏≤", r"‡∏ï‡∏±‡∏î", r"‡∏Å‡∏£‡∏µ‡∏î", r"‡∏Å‡∏£‡∏∞‡∏ä‡∏≤‡∏Å", r"‡πÅ‡∏ó‡∏á", r"‡∏ö‡∏µ‡∏ö‡∏Ñ‡∏≠",
        r"‡∏ó‡∏∞‡πÄ‡∏•‡∏≤‡∏∞", r"‡∏ó‡∏≥‡∏£‡πâ‡∏≤‡∏¢", r"‡∏Å‡∏£‡∏∞‡πÇ‡∏î‡∏î‡∏à‡∏≤‡∏Å", r"‡∏ó‡∏£‡∏°‡∏≤‡∏ô",

        # ‡∏Ñ‡∏≥‡∏•‡πà‡∏≠‡πÅ‡∏´‡∏•‡∏°/‡∏•‡∏≤‡∏°‡∏Å/‡πÄ‡∏û‡∏®
        r"‡πÄ‡∏õ‡∏•‡∏∑‡∏≠‡∏¢", r"‡πÇ‡∏õ‡πä", r"‡∏ô‡∏π‡πâ‡∏î", r"‡∏•‡∏≤‡∏°‡∏Å", r"‡∏°‡∏µ‡πÄ‡∏û‡∏®", r"‡∏£‡πà‡∏ß‡∏°‡πÄ‡∏û‡∏®", r"‡∏Å‡∏≠‡∏î", r"‡∏à‡∏π‡∏ö",
        r"‡∏≠‡∏≤‡∏ö‡∏ô‡πâ‡∏≥", r"‡∏ñ‡∏≠‡∏î‡πÄ‡∏™‡∏∑‡πâ‡∏≠", r"‡∏¢‡∏±‡πà‡∏ß", r"‡πÄ‡∏ã‡πá‡∏Å‡∏ã‡∏µ‡πà", r"‡∏Ç‡πà‡∏°‡∏Ç‡∏∑‡∏ô", r"‡∏≠‡∏ô‡∏≤‡∏à‡∏≤‡∏£",

        # ‡∏Ñ‡∏≥‡∏ú‡∏¥‡∏î‡∏®‡∏µ‡∏•‡∏ò‡∏£‡∏£‡∏°/‡∏¢‡∏≤‡πÄ‡∏™‡∏û‡∏ï‡∏¥‡∏î
        r"‡∏¢‡∏≤‡πÄ‡∏™‡∏û‡∏ï‡∏¥‡∏î", r"‡∏Å‡∏±‡∏ç‡∏ä‡∏≤", r"‡πÄ‡∏Æ‡πÇ‡∏£‡∏≠‡∏µ‡∏ô", r"‡πÄ‡∏™‡∏û", r"‡∏î‡∏π‡∏î", r"‡∏â‡∏µ‡∏î", r"‡πÄ‡∏´‡∏•‡πâ‡∏≤", r"‡πÄ‡∏ö‡∏µ‡∏¢‡∏£‡πå", r"‡πÄ‡∏°‡∏≤",
        r"‡∏™‡∏π‡∏ö‡∏ö‡∏∏‡∏´‡∏£‡∏µ‡πà", r"‡∏ö‡∏∏‡∏´‡∏£‡∏µ‡πà", r"‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏î‡∏∑‡πà‡∏°‡πÅ‡∏≠‡∏•‡∏Å‡∏≠‡∏Æ‡∏≠‡∏•‡πå",

        # ‡∏≠‡∏≤‡∏ß‡∏∏‡∏ò/‡∏†‡∏±‡∏¢
        r"‡∏õ‡∏∑‡∏ô", r"‡∏°‡∏µ‡∏î", r"‡∏£‡∏∞‡πÄ‡∏ö‡∏¥‡∏î", r"‡∏Ñ‡∏ß‡∏±‡∏ô", r"‡πÑ‡∏ü‡πÑ‡∏´‡∏°‡πâ", r"‡∏≠‡∏≤‡∏ß‡∏∏‡∏ò", r"‡∏£‡∏∞‡πÄ‡∏ö‡∏¥‡∏î‡∏ô‡∏¥‡∏ß‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå", r"‡∏™‡∏á‡∏Ñ‡∏£‡∏≤‡∏°",

        # ‡∏™‡∏±‡∏ï‡∏ß‡πå‡πÅ‡∏•‡∏∞‡∏™‡∏¥‡πà‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏™‡∏°
        r"‡∏´‡∏ô‡∏≠‡∏ô", r"‡πÑ‡∏™‡πâ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô", r"‡πÅ‡∏°‡∏•‡∏á", r"‡πÅ‡∏°‡∏•‡∏á‡∏ß‡∏±‡∏ô", r"‡πÅ‡∏°‡∏•‡∏á‡∏™‡∏≤‡∏ö", r"‡∏®‡∏û", r"‡∏ú‡∏µ", r"‡∏ã‡∏≤‡∏Å‡∏®‡∏û",

        # ‡∏Ñ‡∏≥‡∏ï‡πâ‡∏≠‡∏á‡∏´‡πâ‡∏≤‡∏°‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ‡∏ó‡∏µ‡πà‡∏°‡∏±‡∏Å trigger ‡∏£‡∏∞‡∏ö‡∏ö
        r"‡∏ó‡∏î‡∏•‡∏≠‡∏á", r"‡∏Å‡∏≤‡∏£‡∏ó‡∏î‡∏•‡∏≠‡∏á", r"‡πÑ‡∏ß‡∏£‡∏±‡∏™", r"‡∏û‡∏¥‡∏©", r"‡πÄ‡∏ä‡∏∑‡πâ‡∏≠‡πÇ‡∏£‡∏Ñ", r"‡∏Ç‡∏≠‡∏á‡πÄ‡∏´‡∏•‡∏ß", r"‡∏Ç‡∏≠‡∏á‡πÄ‡∏´‡∏•‡∏ß‡πÉ‡∏ô‡∏£‡πà‡∏≤‡∏á‡∏Å‡∏≤‡∏¢",
        r"‡∏Å‡∏£‡∏∞‡∏î‡∏π‡∏Å", r"‡πÄ‡∏ô‡∏∑‡πâ‡∏≠", r"‡∏Ñ‡∏£‡∏≤‡∏ö‡πÄ‡∏•‡∏∑‡∏≠‡∏î", r"‡∏Ü‡∏≤‡∏ï‡∏Å‡∏£", r"‡∏Å‡∏≤‡∏£‡∏•‡πà‡∏≤", r"‡∏Å‡∏≤‡∏£‡∏•‡πà‡∏ß‡∏á‡∏•‡∏∞‡πÄ‡∏°‡∏¥‡∏î",
    ]


    filtered = []
    for pattern in bad_words:
        if re.search(pattern, prompt, flags=re.IGNORECASE):
            filtered.append(pattern)
            prompt = re.sub(pattern, "[‡∏Ñ‡∏≥‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢]", prompt, flags=re.IGNORECASE)

    if filtered:
        logger.warning("‚ö†Ô∏è Filtered prompt due to: %s", ", ".join(filtered))

    return prompt


# ========== 5. ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏†‡∏≤‡∏û‡∏à‡∏≤‡∏Å DALL¬∑E ‡∏û‡∏£‡πâ‡∏≠‡∏° fallback ==========
def simplify_prompt(text: str) -> str:
    """
    ‡πÅ‡∏õ‡∏•‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° text ‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ ‡∏°‡∏≤‡πÄ‡∏õ‡πá‡∏ô prompt ‡∏ó‡∏µ‡πà‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢
    """
    keywords = [
        "‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô", "‡πÄ‡∏î‡πá‡∏Å‡∏´‡∏ç‡∏¥‡∏á", "‡πÄ‡∏î‡πá‡∏Å‡∏ä‡∏≤‡∏¢", "‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏£‡∏π", "‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠", "‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå", "‡∏ò‡∏£‡∏£‡∏°‡∏ä‡∏≤‡∏ï‡∏¥",
        "‡∏™‡∏ô‡∏≤‡∏°‡πÄ‡∏î‡πá‡∏Å‡πÄ‡∏•‡πà‡∏ô", "‡πÅ‡∏™‡∏á‡πÅ‡∏î‡∏î", "‡∏™‡∏ß‡∏ô", "‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô", "‡∏™‡∏±‡∏ï‡∏ß‡πå", "‡∏Ñ‡∏£‡∏≠‡∏ö‡∏Ñ‡∏£‡∏±‡∏ß", "‡∏£‡∏≠‡∏¢‡∏¢‡∏¥‡πâ‡∏°", "‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏∏‡∏Ç"
    ]
    found = [word for word in keywords if word in text]
    description = "‡πÅ‡∏•‡∏∞".join(found[:2]) if found else "‡πÄ‡∏î‡πá‡∏Å‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÉ‡∏ô‡∏ö‡∏£‡∏£‡∏¢‡∏≤‡∏Å‡∏≤‡∏®‡∏≠‡∏ö‡∏≠‡∏∏‡πà‡∏ô"
    return f"{description} ‡∏™‡πÑ‡∏ï‡∏•‡πå‡∏Å‡∏≤‡∏£‡πå‡∏ï‡∏π‡∏ô cartoon style, storybook illustration, soft lighting, happy atmosphere, child-friendly"


def generate_dalle_image(prompt: str) -> str:
    """
    ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏†‡∏≤‡∏û‡∏à‡∏≤‡∏Å prompt (‡∏´‡∏£‡∏∑‡∏≠ fallback prompt ‡∏ñ‡πâ‡∏≤ content policy reject)
    """
    safe_prompt = sanitize_prompt(prompt)
    styled_prompt = safe_prompt + ", cartoon style, storybook illustration, soft lighting, warm colors, vibrant, highly detailed, happy atmosphere, cozy, child-friendly"

    try:
        response = client.images.generate(
            model="dall-e-3",
            prompt=styled_prompt,
            size="1024x1024",
            quality="standard",
            n=1
        )
        return response.data[0].url

    except Exception as e:
        logger.warning("‚ùå ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏†‡∏≤‡∏û‡∏à‡∏≤‡∏Å prompt ‡πÄ‡∏î‡∏¥‡∏°‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: %s", str(e))

        # fallback
        fallback_prompt = simplify_prompt(prompt)
        logger.info("üé® ‡πÉ‡∏ä‡πâ fallback prompt: %s", fallback_prompt)

        try:
            response = client.images.generate(
                model="dall-e-3",
                prompt=fallback_prompt,
                size="1024x1024",
                quality="standard",
                n=1
            )
            return response.data[0].url

        except Exception as e2:
            logger.error("‚ùå fallback prompt ‡∏Å‡πá‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß: %s", str(e2))
            return "https://yourdomain.com/static/default_image.png"


# ========== 6. ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô ==========
if __name__ == "__main__":
    pdf_path = "example_lesson.pdf"
    with open(pdf_path, "rb") as f:
        raw_text = extract_text_from_pdf(f)

    scenes = summarize_to_scenes(raw_text)
    logger.info("üìö ‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î %d ‡∏â‡∏≤‡∏Å", len(scenes))

    for scene in scenes:
        try:
            logger.info("üîπ ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏â‡∏≤‡∏Å‡∏ó‡∏µ‡πà %d ‚Ä¶", scene["scene"])
            image_url = generate_dalle_image(scene["image_prompt"])
            tts_bytes = generate_tts_audio(scene["text"])

            logger.info("‚úÖ ‡∏â‡∏≤‡∏Å %d ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏™‡∏£‡πá‡∏à: ‡∏†‡∏≤‡∏û = %s, ‡πÄ‡∏™‡∏µ‡∏¢‡∏á = %d bytes", scene["scene"], image_url, len(tts_bytes))

            # ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î Supabase ‡∏´‡∏£‡∏∑‡∏≠‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà‡πÑ‡∏î‡πâ

        except Exception as e:
            logger.error("‚ùå ‡∏â‡∏≤‡∏Å %d ‡∏°‡∏µ‡∏õ‡∏±‡∏ç‡∏´‡∏≤: %s", scene["scene"], str(e))
            continue

    logger.info("üéâ ‡∏ó‡∏∏‡∏Å‡∏â‡∏≤‡∏Å‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô!")
